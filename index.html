<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ù†Ø§Ù†ÙŠ Ø¨ÙŠØª Ø§Ù„Ø¹Ø·ÙˆØ± ÙˆØ§Ù„Ø¨Ø®ÙˆØ±</title>
    <link rel="manifest" href="./manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…ÙˆÙ‚Ø¹ */
        :root { --green: #1b4332; --orange: #e67e22; --bg: #f0f2f5; --admin-color: #2c3e50; --purple: #8e44ad; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; direction: rtl; overflow-x: hidden; }
        
        .welcome-ticker { background: #1b4332; color: white; padding: 8px 0; overflow: hidden; border-bottom: 2px solid #e67e22; width: 100%; position: relative; z-index: 2000; }
        .welcome-track { display: flex; width: max-content; animation: scrollInfinite 40s linear infinite; }
        @keyframes scrollInfinite { 0% { transform: translateX(0); } 100% { transform: translateX(50%); } }
        .welcome-msg { padding: 0 50px; font-weight: bold; font-size: 0.9rem; white-space: nowrap; }

        header { background: linear-gradient(rgba(27,67,50,0.95), rgba(27,67,50,0.85)), url('https://images.pexels.com/photos/2802527/pexels-photo-2802527.jpeg?auto=compress&cs=tinysrgb&w=1200'); background-size: cover; color: white; padding: 20px 20px 10px 20px; text-align: center; border-bottom: 5px solid var(--orange); position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .header-actions-container { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 15px; }
        .top-btn { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; backdrop-filter: blur(5px); transition: 0.3s; }

        .admin-panel { background: white; padding: 25px; margin: 20px auto; max-width: 1000px; border-radius: 20px; display: none; border-top: 5px solid var(--admin-color); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        .admin-tab-btns { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .sub-tab-btn { padding: 10px 20px; background: #eee; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; flex: 1; white-space: nowrap; }
        .sub-tab-btn.active { background: var(--admin-color); color: white; }
        .admin-input { padding: 10px; border: 1px solid #ddd; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 8px; outline: none; font-family: 'Tajawal'; }

        .merchants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .merchant-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; }
        .merchant-card:hover { transform: translateY(-5px); border-color: var(--purple); box-shadow: 0 5px 15px rgba(142, 68, 173, 0.2); }
        .merchant-img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #eee; }
        
        .merchant-products-editor { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; max-height: 500px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 10px; border: 1px solid #ddd; }
        .simple-prod-card { background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; }
        .simple-prod-img { width: 100%; height: 100px; border-radius: 6px; object-fit: contain; }
        
        .mini-nav-container { display: flex; overflow-x: auto; white-space: nowrap; gap: 5px; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .mini-tab-btn { padding: 6px 15px; border: 1px solid #ccc; background: white; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }
        .mini-tab-btn.active { background: var(--purple); color: white; border-color: var(--purple); }

        .btn-assign { width: 100%; padding: 8px; border: 1px solid #ccc; background: #f0f0f0; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-assign.assigned { background: var(--purple); color: white; border-color: var(--purple); }
        
        .container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 768px) { .container { grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px; } }

        .card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; position: relative; border: 1px solid #eee; transition: 0.3s; height: 100%; }
        .card img { width: 100%; height: 130px; object-fit: cover; cursor: pointer; }
        
        .card-content { padding: 10px; display: flex; flex-direction: column; justify-content: space-between; flex-grow: 1; }
        .product-title { font-size: 0.9rem; margin: 0 0 8px 0; height: 38px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.35; }

        .badge-pill { position: absolute; top: 10px; padding: 3px 8px; border-radius: 10px; font-size: 10px; z-index: 5; font-weight: bold; color: white; }
        .pinned-badge { right: 10px; background: var(--orange); }
        .wholesale-badge { left: 10px; background: #c0392b; }
        .merchant-badge { left: 10px; background: var(--purple); }

        .price-tag { color: var(--orange); font-weight: bold; font-size: 1rem; }
        .special-price { color: var(--purple) !important; font-size: 1.1rem; }
        .wholesale-mode-price { color: #c0392b !important; }
        
        .add-btn { background: var(--green); color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 0.85rem; width: 100%; margin-top: 8px; }

        .nav-tabs-container { background: white; position: sticky; top: 0; z-index: 1000; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 10px 0; }
        .nav-tabs-track { display: flex; width: max-content; animation: scrollTabs 30s linear infinite; }
        @keyframes scrollTabs { 0% { transform: translateX(0); } 100% { transform: translateX(33.33%); } }
        .tab-btn { padding: 8px 22px; margin: 0 5px; border: 1.5px solid var(--green); background: none; border-radius: 25px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .tab-btn.active { background: var(--green); color: white; }

        .modal { display: none; position: fixed; z-index: 3000; inset: 0; background: rgba(0,0,0,0.85); padding: 15px; overflow-y: auto; }
        .modal-content { background: white; margin: 20px auto; padding: 25px; width: 95%; max-width: 550px; border-radius: 25px; position: relative; }
        
        #floatingCart { position: fixed; left: 20px; bottom: 30px; width: 65px; height: 65px; background: #25D366; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 30px; z-index: 5000; cursor: move; user-select: none; touch-action: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.1s; }
        #floatingCart:active { transform: scale(0.95); }

        .badge { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 11px; display: flex; justify-content: center; align-items: center; border: 2px solid white; pointer-events: none; }
        .cart-qty-btn { background: #eee; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; }

        .edit-box { padding: 10px; background: #f9f9f9; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .btn-pin, .btn-del, .edit-order-input { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 6px; font-family: 'Tajawal'; font-size: 0.85rem; border: 1px solid #ccc; }
        .btn-pin { background: #ddd; color: #333; border: none; font-weight: bold; }
        .btn-pin.active { background: var(--orange); color: white; }
        .edit-order-input { text-align: center; }
        .btn-del { background: #c0392b; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .save-edit-btn { background: var(--admin-color); color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 1rem; }

        .log-item { background: #fff; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .log-action { font-weight: bold; font-size: 0.85rem; }
        .log-undo-btn { background: #34495e; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.75rem; }
        .log-tag { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.7rem; margin-left: 5px; }

        /* ØªÙ€Ù†Ù€Ø³Ù€ÙŠÙ€Ù‚ ÙˆØ§Ø¬Ù€Ù‡Ù€Ø© Ø§Ù„Ù€ØªÙ€Ø«Ù€Ø¨Ù€ÙŠÙ€Øª Ø§Ù„Ù€Ø¬Ù€Ø¯ÙŠÙ€Ø¯Ø© */
        #pwa-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 99999; display: none; flex-direction: column;
        }
        .pwa-top-transparent { height: 50%; width: 100%; background: transparent; cursor: pointer; }
        .pwa-bottom-panel {
            height: 50%; width: 100%; background: white;
            border-top-left-radius: 35px; border-top-right-radius: 35px;
            box-shadow: 0 -15px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; box-sizing: border-box; text-align: center;
            animation: slideUpPWA 0.5s ease-out;
        }
        @keyframes slideUpPWA { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .pwa-btn-main {
            background: var(--green); color: white; border: none; padding: 18px 0; width: 90%;
            border-radius: 15px; font-weight: bold; font-size: 1.2rem; margin-top: 20px; cursor: pointer;
        }
        .pwa-close-link { color: #888; margin-top: 15px; font-size: 0.9rem; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

<div id="pwa-overlay">
    <div class="pwa-top-transparent" onclick="triggerAppInstall()"></div>
    <div class="pwa-bottom-panel">
        <img src="https://cdn-icons-png.flaticon.com/512/2830/2830305.png" style="width: 70px; margin-bottom: 10px;">
        <h2 style="margin:0; color:var(--green);">ØªØ«Ø¨ÙŠØª Ù…ØªØ¬Ø± Ø­Ù†Ø§Ù†ÙŠ</h2>
        <p style="color:#666; margin: 10px 0;">Ø£Ø¶Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø´Ø§Ø´ØªÙƒ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹.</p>
        <button class="pwa-btn-main" onclick="triggerAppInstall()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù† âœ…</button>
        <div class="pwa-close-link" onclick="closePWA()">Ø¥ØºÙ„Ø§Ù‚ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØµÙØ­</div>
    </div>
</div>

<div class="welcome-ticker">
    <div class="welcome-track">
        <span class="welcome-msg">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ØªØ¬Ø± Ø­Ù†Ø§Ù†ÙŠ Ø¨ÙŠØª Ø§Ù„Ø¹Ø·ÙˆØ± ÙˆØ§Ù„Ø¨Ø®ÙˆØ± - Ø§Ù„Ø£ØµØ§Ù„Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù†Ø° 1969 ğŸŒ¿</span>
        <span class="welcome-msg">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…ØªØ¬Ø± Ø­Ù†Ø§Ù†ÙŠ Ø¨ÙŠØª Ø§Ù„Ø¹Ø·ÙˆØ± ÙˆØ§Ù„Ø¨Ø®ÙˆØ± - Ø§Ù„Ø£ØµØ§Ù„Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù†Ø° 1969 ğŸŒ¿</span>
    </div>
</div>

<header>
    <h1>ğŸŒ¿ Ø­Ù†Ø§Ù†ÙŠ Ø¨ÙŠØª Ø§Ù„Ø¹Ø·ÙˆØ± ÙˆØ§Ù„Ø¨Ø®ÙˆØ±</h1>
    <p id="mode-text">Ø§Ù„Ø£ØµØ§Ù„Ø© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù†Ø° 1969</p>
    <div class="header-actions-container">
        <button class="top-btn" onclick="loginAdmin()">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        <button class="top-btn" id="wholesaleToggle" onclick="handleLogin()">ğŸ›’ ØªØ¬Ø§Ø±</button>
    </div>
</header>

<div class="admin-panel" id="adminPanel">
    <div class="admin-tab-btns">
        <button class="sub-tab-btn active" onclick="switchAdminTab('products')">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        <button class="sub-tab-btn" onclick="switchAdminTab('merchants')">Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¬Ø§Ø±</button>
        <button class="sub-tab-btn" onclick="switchAdminTab('logs')" style="background: #e74c3c; color: white;">ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
    <div id="admin-products-tab">
        <div style="background: #e3f2fd; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #bbdefb; color: #0d47a1; text-align: center;">
            ğŸ’¡ <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ <b>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</b> ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„.
        </div>
        <h3>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
            <input type="text" id="p-name" class="admin-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="p-price" class="admin-input" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªØ¬Ø²Ø¦Ø©">
            <input type="number" id="p-price-w" class="admin-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù„Ø©">
            <input type="number" id="p-amt" class="admin-input" placeholder="Ø§Ù„ÙˆØ²Ù†">
            <select id="p-unit" class="admin-input"><option>ØºØ±Ø§Ù…</option><option>Ù…Ù„</option><option>Ù‚Ø·Ø¹Ø©</option></select>
            <input type="number" step="0.01" id="p-order" class="admin-input" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ±ØªÙŠØ¨">
            <input type="text" id="p-img" class="admin-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" style="grid-column: span 2;">
            <textarea id="p-desc" class="admin-input" placeholder="Ø§Ù„ÙˆØµÙ..." style="grid-column: span 2; height: 60px;"></textarea>
            <select id="p-cat" class="admin-input" style="grid-column: span 2;"><option>ØªÙˆØ§Ø¨Ù„</option><option>Ø£Ø¹Ø´Ø§Ø¨</option><option>Ø²ÙŠÙˆØª</option><option>ØªØ¬Ù…ÙŠÙ„</option><option>Ø¹Ø·ÙˆØ±</option><option>Ø¹Ù†Ø§ÙŠØ©</option><option>Ù…Ø³Ù…Ù†Ø§Øª</option></select>
            <button onclick="saveProduct()" style="grid-column: span 2; background: var(--orange); color: white; padding: 12px; border: none; border-radius: 10px; font-weight: bold;">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>
    </div>
    <div id="admin-merchants-tab" style="display: none;">
        <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±</h3>
        <div id="merchants-list" class="merchants-grid"></div>
        <div id="merchant-editor" style="display: none; margin-top: 20px; border-top: 2px solid #ccc; padding-top: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="margin:0;">ğŸ› ï¸ ØªØ®ØµÙŠØµ: <span id="editor-merchant-name"></span></h4>
                <button onclick="closeMerchantEditor()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
            <div id="merchant-filter-bar" class="mini-nav-container"></div>
            <div id="merchant-products-grid" class="merchant-products-editor"></div>
        </div>
    </div>
    <div id="admin-logs-tab" style="display: none;"><div id="logs-list"></div></div>
</div>

<div class="nav-tabs-container"><div class="nav-tabs-track" id="tabs-track"></div></div>
<div class="container" id="grid"></div>

<div id="productModal" class="modal" onclick="if(event.target==this) closeProduct()">
    <div class="modal-content" id="product-detail-content"></div>
</div>

<div id="adminEditModal" class="modal">
    <div class="modal-content">
        <span onclick="document.getElementById('adminEditModal').style.display='none'" style="position:absolute; left:20px; top:15px; font-size:30px; cursor:pointer;">&times;</span>
        <div id="edit-form-container"></div>
    </div>
</div>

<div id="floatingCart">ğŸ›’<div class="badge" id="cart-badge">0</div></div>

<div id="cartModal" class="modal">
    <div class="modal-content">
        <h3 id="cart-title" style="text-align: center;">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
        <div id="cart-items" style="max-height: 250px; overflow-y: auto;"></div>
        <div style="background: #f9f9f9; padding: 15px; border-radius: 15px; margin-top:10px;">
            <input type="text" id="cust-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="admin-input">
            <input type="tel" id="cust-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="admin-input">
            <select id="ship-type" class="admin-input" onchange="updateCartUI()">
                <option value="600">ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (600 Ø¯Ø¬)</option>
                <option value="400">ØªÙˆØµÙŠÙ„ Ù„Ù„Ù…ÙƒØªØ¨ (400 Ø¯Ø¬)</option>
                <option value="150">Ø¯Ø§Ø®Ù„ Ø¨Ø¦Ø± Ø§Ù„Ø¹Ø§ØªØ± (150 Ø¯Ø¬) ğŸ“</option>
            </select>
            <div id="wilaya-section"><select id="cust-wilaya" class="admin-input"></select></div>
            <div id="address-section"><input type="text" id="cust-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" class="admin-input"></div>
        </div>
        <div style="font-size: 1.4rem; font-weight: bold; text-align: center; color: var(--orange); margin: 20px 0;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="final-total">0</span> Ø¯Ø¬</div>
        <button onclick="checkout()" style="background: #25D366; color: white; padding: 18px; border: none; border-radius: 15px; width: 100%;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ âœ…</button>
        <button onclick="closeCart()" style="display: block; margin: 10px auto; background: none; border: none; color: #888;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const config = { adminKey: "aGFuYW5pMTk2OQ==", adminSecurePass: "hanani1969", wholesalePass: "jumlajumla", whatsapp: "213660913779" };
    const firebaseConfig = { databaseURL: "https://hananistore-2a8fb-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const catOrder = ['ØªÙˆØ§Ø¨Ù„', 'Ø£Ø¹Ø´Ø§Ø¨', 'Ø²ÙŠÙˆØª', 'ØªØ¬Ù…ÙŠÙ„', 'Ø¹Ø·ÙˆØ±', 'Ù…Ø³Ù…Ù†Ø§Øª', 'Ø¹Ù†Ø§ÙŠØ©'];
    let products = [], merchants = [], logs = [], cart = [], isAdmin = false;
    let currentMode = 'retail', currentMerchant = null, filter = 'Ø§Ù„ÙƒÙ„';

    // Ù…Ù€Ù†Ù€Ø·Ù€Ù‚ PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('pwa-overlay').style.display = 'flex';
    });

    async function triggerAppInstall() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            document.getElementById('pwa-overlay').style.display = 'none';
            deferredPrompt = null;
        }
    }
    function closePWA() { document.getElementById('pwa-overlay').style.display = 'none'; }

    // Ø§Ù„Ù€ÙˆØ¸Ù€Ø§Ø¦Ù€Ù Ø§Ù„Ø£ØµÙ€Ù„Ù€ÙŠÙ€Ø© Ù„Ù€Ù„Ù€Ù…Ù€ÙˆÙ‚Ù€Ø¹
    function init() {
        // ØªØ³Ø¬ÙŠÙ„ Service Worker Ø¨Ù…Ø³Ø§Ø± Ù†Ø³Ø¨ÙŠ Ù„ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ GitHub Pages ÙÙŠ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ
        if ('serviceWorker' in navigator) { 
            navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker Registered', reg))
            .catch(err => console.log('SW Registration Failed', err)); 
        }
        
        const w = ["Ø£Ø¯Ø±Ø§Ø±","Ø§Ù„Ø´Ù„Ù","Ø§Ù„Ø£ØºÙˆØ§Ø·","Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ","Ø¨Ø§ØªÙ†Ø©","Ø¨Ø¬Ø§ÙŠØ©","Ø¨Ø³ÙƒØ±Ø©","Ø¨Ø´Ø§Ø±","Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©","Ø§Ù„Ø¨ÙˆÙŠØ±Ø©","ØªÙ…Ù†Ø±Ø§Ø³Øª","ØªØ¨Ø³Ø©","ØªÙ„Ù…Ø³Ø§Ù†","ØªÙŠØ§Ø±Øª","ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","Ø§Ù„Ø¬Ù„ÙØ©","Ø¬ÙŠØ¬Ù„","Ø³Ø·ÙŠÙ","Ø³Ø¹ÙŠØ¯Ø©","Ø³ÙƒÙŠÙƒØ¯Ø©","Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³","Ø¹Ù†Ø§Ø¨Ø©","Ù‚Ø§Ù„Ù…Ø©","Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©","Ø§Ù„Ù…Ø¯ÙŠØ©","Ù…Ø³ØªØºØ§Ù†Ù…","Ø§Ù„Ù…Ø³ÙŠÙ„Ø©","Ù…Ø¹Ø³ÙƒØ±","ÙˆØ±Ù‚Ù„Ø©","ÙˆÙ‡Ø±Ø§Ù†","Ø§Ù„Ø¨ÙŠØ¶","Ø¥Ù„ÙŠØ²ÙŠ","Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬","Ø§Ù„Ø·Ø§Ø±Ù","ØªÙ†Ø¯ÙˆÙ","ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª","Ø§Ù„ÙˆØ§Ø¯ÙŠ","Ø®Ù†Ø´Ù„Ø©","Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³","ØªÙŠØ¨Ø§Ø²Ø©","Ù…ÙŠÙ„Ø©","Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰","Ø§Ù„Ù†Ø¹Ø§Ù…Ø©","Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª","ØºØ±Ø¯Ø§ÙŠØ©","ØºÙ„ÙŠØ²Ø§Ù†"];
        const select = document.getElementById('cust-wilaya');
        w.forEach((name, i) => select.innerHTML += `<option>${i+1} - ${name}</option>`);

        document.getElementById('tabs-track').innerHTML = ['Ø§Ù„ÙƒÙ„', ...catOrder, ...catOrder].map(cat => 
            `<button class="tab-btn ${cat === 'Ø§Ù„ÙƒÙ„' ? 'active' : ''}" onclick="render('${cat}', this)">${cat}</button>`
        ).join('');

        db.ref('products').on('value', (s) => {
            products = s.val() ? Object.values(s.val()) : [];
            products.sort((a, b) => {
                let cA = catOrder.indexOf(a.cat), cB = catOrder.indexOf(b.cat);
                if (cA !== cB) return (cA === -1 ? 99 : cA) - (cB === -1 ? 99 : cB);
                if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
                let oA = parseFloat(a.orderIndex) || 9999, oB = parseFloat(b.orderIndex) || 9999;
                return oA - oB;
            });
            render();
        });
        db.ref('merchants').on('value', (s) => { merchants = Object.values(s.val()||{}); renderMerchantsList(); });
        dragElement(document.getElementById("floatingCart"));
    }

    function render(cat, btn) {
        if(cat) filter = cat;
        if(btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
        const grid = document.getElementById('grid'); grid.innerHTML = "";
        let display = products;
        if (currentMode === 'merchant' && currentMerchant) display = products.filter(p => currentMerchant.assignedProducts && currentMerchant.assignedProducts[p.id]);

        display.filter(p => filter === 'Ø§Ù„ÙƒÙ„' || p.cat === filter).forEach(p => {
            let pr = p.price;
            if (currentMode === 'wholesale') pr = p.wholesalePrice || p.price;
            else if (currentMode === 'merchant' && currentMerchant) pr = (currentMerchant.customPrices && currentMerchant.customPrices[p.id]) || p.wholesalePrice || p.price;
            
            grid.innerHTML += `<div class="card">${p.pinned ? '<div class="badge-pill pinned-badge">â­</div>' : ''}
                <img src="${p.img || 'https://via.placeholder.com/150'}" onclick="handleProductClick('${p.id}')">
                <div class="card-content"><h3 class="product-title">${p.name}</h3>
                <div class="info-row"><span class="price-tag">${pr} Ø¯Ø¬</span><span>${p.baseAmt}${p.unit}</span></div>
                ${isAdmin ? getAdminControls(p) : getAddToCartBtn(p)}</div></div>`;
        });
    }

    // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø³Ù„Ø©
    function handleProductClick(id) { if(isAdmin) openAdminEditModal(id); else openProduct(id); }
    function getAdminControls(p) { return `<div class="edit-box"><button class="btn-pin ${p.pinned ? 'active' : ''}" onclick="togglePin('${p.id}')">ğŸ“Œ ØªØ«Ø¨ÙŠØª</button><button class="btn-del" onclick="delProd('${p.id}', '${p.name}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></div>`; }
    function getAddToCartBtn(p) { return `<input type="number" id="qty-${p.id}" value="${p.baseAmt}" style="width:100%; text-align:center; margin-bottom:5px;"><button class="add-btn" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© ğŸ›’</button>`; }
    function loginAdmin() { if (btoa(prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:")) === config.adminKey) { isAdmin = !isAdmin; document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none'; render(); } }
    function handleLogin() { let pass = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:"); if(pass === config.wholesalePass) { currentMode = 'wholesale'; render(); } }
    function togglePin(id) { db.ref('products/' + id).update({ pinned: !products.find(x => x.id === id).pinned }); }
    function delProd(id, n) { if(confirm(`Ø­Ø°Ù ${n}?`)) db.ref('products/'+id).remove(); }
    function addToCart(id) { 
        const p = products.find(x => x.id === id); 
        const q = parseFloat(document.getElementById('qty-'+id).value); 
        cart.push({...p, selectedQty: q, finalPrice: Math.round((p.price/p.baseAmt)*q)}); 
        updateCartBadge(); alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); 
    }
    function updateCartBadge() { document.getElementById('cart-badge').innerText = cart.length; }
    function showCart() { document.getElementById('cartModal').style.display = 'block'; updateCartUI(); }
    function closeCart() { document.getElementById('cartModal').style.display = 'none'; }
    function updateCartUI() { 
        let sub = 0; cart.forEach(i => sub += i.finalPrice); 
        document.getElementById('cart-items').innerHTML = cart.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.name} (${i.selectedQty}${i.unit})</span><span>${i.finalPrice} Ø¯Ø¬</span></div>`).join('');
        document.getElementById('final-total').innerText = sub + parseInt(document.getElementById('ship-type').value); 
    }
    // Ø¯Ø§Ù„Ø© checkout Ù…ÙÙ‚ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„ÙƒÙ† ØªØ±ÙƒØªÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©
    function checkout() { 
        let text = "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ø±ÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:%0a";
        cart.forEach(i => text += `- ${i.name} (${i.selectedQty} ${i.unit}) - ${i.finalPrice} Ø¯Ø¬%0a`);
        text += `%0aØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${document.getElementById('final-total').innerText} Ø¯Ø¬`;
        text += `%0aØ§Ù„Ø§Ø³Ù…: ${document.getElementById('cust-name').value}`;
        text += `%0aØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${document.getElementById('cust-wilaya').value} - ${document.getElementById('cust-address').value}`;
        window.open(`https://wa.me/${config.whatsapp}?text=${text}`, '_blank');
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;
        elmnt.ontouchstart = dragMouseDown;
        function dragMouseDown(e) {
            e = e || window.event;
            // e.preventDefault(); // ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡ Ù„ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ·
            if(e.type === 'touchstart') { pos3 = e.touches[0].clientX; pos4 = e.touches[0].clientY; } 
            else { pos3 = e.clientX; pos4 = e.clientY; }
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
            document.ontouchend = closeDragElement;
            document.ontouchmove = elementDrag;
        }
        function elementDrag(e) {
            e = e || window.event;
            // e.preventDefault();
            let cx, cy;
            if(e.type === 'touchmove') { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
            else { cx = e.clientX; cy = e.clientY; }
            pos1 = pos3 - cx; pos2 = pos4 - cy;
            pos3 = cx; pos4 = cy;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; }
    }
    
    // ÙØªØ­ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§
    document.getElementById('floatingCart').addEventListener('click', function(e){
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù†Ù‚Ø±Ø© ÙˆÙ„ÙŠØ³ Ø³Ø­Ø¨
        showCart();
    });

    init();
</script>
</body>
</html>